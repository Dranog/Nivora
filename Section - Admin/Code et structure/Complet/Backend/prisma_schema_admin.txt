// packages/database/prisma/schema.prisma
// ADMIN MODELS WITH OPTIMIZED INDEXES

// ==========================================
// ADMIN MODELS
// ==========================================

model AuditLog {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())
  actorId   String
  actor     User     @relation("AuditLogActor", fields: [actorId], references: [id])
  action    String
  targetType String
  targetId   String?
  metadata  Json
  ip        String
  userAgent String
  device    String
  hash      String
  prevHash  String?
  
  @@index([actorId, timestamp(sort: Desc)])
  @@index([action, timestamp(sort: Desc)])
  @@index([targetType, targetId])
  @@index([timestamp(sort: Desc)])
  @@map("audit_logs")
}

model Report {
  id              String       @id @default(cuid())
  reporterId      String
  reporter        User         @relation("ReportsMade", fields: [reporterId], references: [id])
  targetId        String
  targetType      TargetType
  reason          String
  description     String?
  priority        Priority     @default(MEDIUM)
  status          ReportStatus @default(PENDING)
  assignedToId    String?
  assignedTo      User?        @relation("ReportsAssigned", fields: [assignedToId], references: [id])
  reviewedById    String?
  reviewedBy      User?        @relation("ReportsReviewed", fields: [reviewedById], references: [id])
  reviewedAt      DateTime?
  aiAnalysis      Json?
  escalationLog   Json[]       @default([])
  resolution      String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([status, priority(sort: Desc)])
  @@index([assignedToId])
  @@index([targetId, targetType])
  @@index([createdAt(sort: Desc)])
  @@index([priority(sort: Desc), createdAt(sort: Desc)])
  @@map("reports")
}

enum TargetType {
  USER
  POST
  MESSAGE
  COMMENT
  PROFILE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
  ESCALATED
}

model KycVerification {
  id              String       @id @default(cuid())
  userId          String       @unique
  user            User         @relation("UserKyc", fields: [userId], references: [id])
  provider        String
  externalId      String?
  status          KycStatus
  documents       Json
  documentKeys    Json
  personalData    Json
  aiScores        Json
  reviewedById    String?
  reviewedBy      User?        @relation("KycReviewedBy", fields: [reviewedById], references: [id])
  reviewedAt      DateTime?
  rejectionReason String?
  expiresAt       DateTime
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@index([createdAt(sort: Desc)])
  @@map("kyc_verifications")
}

enum KycStatus {
  PENDING
  UNDER_REVIEW
  VERIFIED
  REJECTED
}

model ModerationDecision {
  id          String   @id @default(cuid())
  contentId   String
  contentType String
  moderatorId String
  moderator   User     @relation("ModerationDecisions", fields: [moderatorId], references: [id])
  decision    Decision
  reason      String
  notes       String?
  aiScorePre  Json?
  createdAt   DateTime @default(now())
  
  @@index([contentId, contentType])
  @@index([moderatorId])
  @@index([createdAt(sort: Desc)])
  @@map("moderation_decisions")
}

enum Decision {
  APPROVE
  REJECT
  ESCALATE
  REQUEST_CHANGES
}

model ExportHistory {
  id           String       @id @default(cuid())
  type         String
  format       String
  initiatedById String
  initiatedBy  User         @relation("ExportsInitiated", fields: [initiatedById], references: [id])
  status       ExportStatus @default(PROCESSING)
  fileUrl      String?
  fileKey      String?
  fileSize     Int?
  rowCount     Int?
  errorMessage String?
  filters      Json?
  createdAt    DateTime     @default(now())
  completedAt  DateTime?
  expiresAt    DateTime?
  
  @@index([initiatedById])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([expiresAt])
  @@map("export_history")
}

enum ExportStatus {
  PROCESSING
  COMPLETED
  FAILED
  EXPIRED
}

model Settings {
  id              String   @id @default("singleton")
  platformName    String   @default("OLIVER")
  contactEmail    String
  darkMode        Boolean  @default(false)
  autoBackup      Boolean  @default(true)
  showTooltips    Boolean  @default(true)
  passwordLength  Int      @default(8)
  require2FA      Boolean  @default(false)
  allowedIPs      String[]
  apiKey          String   @unique
  updatedAt       DateTime @updatedAt
  updatedById     String?
  
  @@map("settings")
}

model ModeratorSession {
  id              String   @id @default(cuid())
  moderatorId     String
  moderator       User     @relation("ModeratorSessions", fields: [moderatorId], references: [id])
  startedAt       DateTime @default(now())
  endedAt         DateTime?
  itemsReviewed   Int      @default(0)
  breaksTaken     Int      @default(0)
  lastBreakAt     DateTime?
  status          String
  
  @@index([moderatorId, startedAt(sort: Desc)])
  @@map("moderator_sessions")
}

// ==========================================
// USER MODEL EXTENSIONS
// ==========================================

model User {
  id                  String   @id @default(cuid())
  email               String   @unique
  username            String   @unique
  password            String
  role                String   @default("USER")
  permissions         Json?
  status              String   @default("ACTIVE")
  emailVerified       Boolean  @default(false)
  avatar              String?
  displayName         String?
  suspendedUntil      DateTime?
  suspensionReason    String?
  lastActiveAt        DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  auditLogsActor      AuditLog[]            @relation("AuditLogActor")
  reportsMade         Report[]              @relation("ReportsMade")
  reportsAssigned     Report[]              @relation("ReportsAssigned")
  reportsReviewed     Report[]              @relation("ReportsReviewed")
  kycVerification     KycVerification?      @relation("UserKyc")
  kycReviewed         KycVerification[]     @relation("KycReviewedBy")
  moderationDecisions ModerationDecision[]  @relation("ModerationDecisions")
  exportsInitiated    ExportHistory[]       @relation("ExportsInitiated")
  moderatorSessions   ModeratorSession[]    @relation("ModeratorSessions")
  
  payments            Payment[]
  payouts             Payout[]
  posts               Post[]
  videos              Video[]
  
  @@index([email])
  @@index([username])
  @@index([role])
  @@index([createdAt(sort: Desc)])
  @@index([lastActiveAt(sort: Desc)])
  @@map("users")
}

model Payment {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  amount         Int
  type           String
  status         String
  processingFee  Int?
  paymentMethod  String?
  metadata       Json?
  createdAt      DateTime @default(now())
  
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt(sort: Desc)])
  @@map("payments")
}

model Payout {
  id          String    @id @default(cuid())
  creatorId   String
  creator     User      @relation(fields: [creatorId], references: [id])
  amount      Int
  status      String
  method      String
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  
  @@index([creatorId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([completedAt(sort: Desc)])
  @@map("payouts")
}

model Post {
  id        String   @id @default(cuid())
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  content   String
  mediaUrls Json?
  deleted   Boolean  @default(false)
  deletedAt DateTime?
  createdAt DateTime @default(now())
  
  @@index([authorId])
  @@index([createdAt(sort: Desc)])
  @@map("posts")
}

model Video {
  id        String   @id @default(cuid())
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  title     String
  url       String
  createdAt DateTime @default(now())
  
  @@index([authorId])
  @@index([createdAt(sort: Desc)])
  @@map("videos")
}

model Content {
  id                String   @id @default(cuid())
  moderationStatus  String
  createdAt         DateTime @default(now())
  reports           Report[]
  
  @@index([moderationStatus])
  @@map("content")
}

// ==========================================
// INDEX MODIFICATIONS SUMMARY
// ==========================================

// Added Desc sort order to timestamp/date indexes for optimal admin queries:
// 
// 1. AuditLog:
//    - timestamp(sort: Desc) for chronological listing
//    - actorId + timestamp(sort: Desc) for user activity history
//    - action + timestamp(sort: Desc) for action-based queries
//
// 2. Report:
//    - createdAt(sort: Desc) for recent reports listing
//    - priority(sort: Desc) + createdAt(sort: Desc) for prioritized queue
//    - status + priority(sort: Desc) for moderation workflow
//
// 3. KycVerification:
//    - createdAt(sort: Desc) for recent submissions
//
// 4. ModerationDecision:
//    - createdAt(sort: Desc) for decision history
//
// 5. ExportHistory:
//    - createdAt(sort: Desc) for export tracking
//
// 6. ModeratorSession:
//    - moderatorId + startedAt(sort: Desc) for session history
//
// 7. User:
//    - createdAt(sort: Desc) for user growth metrics
//    - lastActiveAt(sort: Desc) for activity tracking
//
// 8. Payment:
//    - createdAt(sort: Desc) for transaction history
//
// 9. Payout:
//    - createdAt(sort: Desc) for payout tracking
//    - completedAt(sort: Desc) for completion history
//
// 10. Post/Video:
//     - createdAt(sort: Desc) for content listings
//
// All modifications support cursor-based pagination with DESC ordering
// for optimal admin panel performance.
